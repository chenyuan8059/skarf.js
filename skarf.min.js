var SKARF=SKARF||{version:"1.0.1"};console.log("Using SKARF "+SKARF.version);SKARF.GuiMarkerFactory={mappings:{},create:function(a,b){if(!a)throw Error("SKARF.GuiMarker type not specified");if(!this.mappings.hasOwnProperty(a))throw Error("SKARF.GuiMarker of this type has not been registered with SKARF.GuiMarkerFactory: "+a);return new this.mappings[a](b)},register:function(a,b){if(this.mappings.hasOwnProperty(a))throw Error("Mapping name already exists: "+a);this.mappings[a]=b}};
SKARF.GuiMarker=function(a){if("undefined"===typeof a.key)throw Error("key not specified");this.__key=a.key;if("undefined"===typeof a.name)throw Error("name not specified");this.__name=a.name;if("undefined"===typeof a.markerId)throw Error("markerId not specified");this.__markerId=a.markerId;if("undefined"===typeof a.markerTransform)throw Error("markerTransform not specified");this.__markerTransform=a.markerTransform;if("undefined"===typeof a.markerSize)throw Error("markerSize not specified");this.__markerSize=
a.markerSize;this.__firstDetected=!0;this.__firstHidden=!1;this.__worldMatrix=null;this.__position=new THREE.Vector3;this.__prevPosition=new THREE.Vector3;this.__dPosition=new THREE.Vector3;this.__moveThresholdLow=0.02;this.__moveThresholdHigh=0.5;this.__worldZAxis=new THREE.Vector3(0,0,1);this.__worldYAxis=new THREE.Vector3(0,1,0);this.__currZAxis=new THREE.Vector3;this.__dRotation=this.__prevRotation=this.__rotation=0;this.__rotThresholdLow=1;this.__rotThresholdHigh=10;this.__callbackObjs={};this.__callbackObjs.moved=
{name:this.__key+"_moved",fn:void 0};this.__callbackObjs.rotated={name:this.__key+"_rotated",fn:void 0};this.__callbackObjs.firstDetected={name:this.__key+"_firstDetected",fn:void 0};this.__callbackObjs.firstHidden={name:this.__key+"_firstHidden",fn:void 0};this.__callbackObjs.detected={name:this.__key+"_detected",fn:void 0};this.__callbackObjs.hidden={name:this.__key+"_hidden",fn:void 0}};
SKARF.GuiMarker.prototype.detected=function(a,b){this.__worldMatrix=b;this.__processPosition(b);this.__processRotation(b);this.__processCallbacks();this.__firstDetected=!1;this.__firstHidden=!0};
SKARF.GuiMarker.prototype.__processPosition=function(a){this.__position.getPositionFromMatrix(a);this.__dPosition.copy(this.__position.clone().sub(this.__prevPosition));a=this.__dPosition.length();a>=this.__moveThresholdLow&&a<=this.__moveThresholdHigh&&this.__invokeCallback("moved",{guiMarker:this,position:this.__position,dPosition:this.__dPosition});this.__prevPosition.copy(this.__position)};
SKARF.GuiMarker.prototype.__processRotation=function(a){this.__currZAxis.getColumnFromMatrix(2,a).normalize();this.__rotation=THREE.Math.radToDeg(Math.acos(this.__currZAxis.dot(this.__worldZAxis)));0>(new THREE.Vector3).crossVectors(this.__currZAxis,this.__worldZAxis).dot(this.__worldYAxis)&&(this.__rotation=360-this.__rotation);this.__dRotation=this.__rotation-this.__prevRotation;a=Math.abs(this.__dRotation);!isNaN(this.__dRotation)&&a>=this.__rotThresholdLow&&a<=this.__rotThresholdHigh&&this.__invokeCallback("rotated",
{guiMarker:this,rotation:this.__rotation,dRotation:this.__dRotation});this.__prevRotation=this.__rotation};SKARF.GuiMarker.prototype.__processCallbacks=function(){this.__invokeCallback("detected",{guiMarker:this,worldMatrix:this.__worldMatrix,position:this.__position,rotation:this.__rotation});this.__firstDetected&&this.__invokeCallback("firstDetected",{guiMarker:this,worldMatrix:this.__worldMatrix,position:this.__position,rotation:this.__rotation})};
SKARF.GuiMarker.prototype.hidden=function(){this.__firstDetected=!0;this.__firstHidden&&(this.__invokeCallback("firstHidden",{guiMarker:this}),this.__firstHidden=!1);this.__invokeCallback("hidden",{guiMarker:this})};SKARF.GuiMarker.prototype.__invokeCallback=function(a,b){var c=this.__callbackObjs[a];if("undefined"===typeof c.fn)try{c.fn=eval(c.name)}catch(d){c.fn=null}c.fn&&c.fn.call(this,b)};SKARF.GenericMarker=function(a){SKARF.GuiMarker.call(this,a)};SKARF.GenericMarker.prototype=Object.create(SKARF.GuiMarker.prototype);
SKARF.GenericMarker.prototype.constructor=SKARF.GenericMarker;SKARF.GuiMarkerFactory.register("generic",SKARF.GenericMarker);SKARF.ButtonMarker=function(a){SKARF.GuiMarker.call(this,a);this.__callbackObjs.clicked={name:this.__key+"_clicked",fn:void 0}};SKARF.ButtonMarker.prototype=Object.create(SKARF.GuiMarker.prototype);SKARF.ButtonMarker.prototype.constructor=SKARF.ButtonMarker;SKARF.GuiMarkerFactory.register("button",SKARF.ButtonMarker);
SKARF.ButtonMarker.prototype.__processCallbacks=function(){this.__firstDetected&&this.__invokeCallback("clicked",{guiMarker:this});SKARF.GuiMarker.prototype.__processCallbacks.call(this)};SKARF.CheckBoxMarker=function(a){SKARF.GuiMarker.call(this,a);this.__callbackObjs.toggled={name:this.__key+"_toggled",fn:void 0};this.checked=!1};SKARF.CheckBoxMarker.prototype=Object.create(SKARF.GuiMarker.prototype);SKARF.CheckBoxMarker.prototype.constructor=SKARF.CheckBoxMarker;
SKARF.GuiMarkerFactory.register("checkbox",SKARF.CheckBoxMarker);SKARF.CheckBoxMarker.prototype.__processCallbacks=function(){this.__firstDetected&&(this.checked=!this.checked,this.__invokeCallback("toggled",{guiMarker:this,checked:this.checked}));SKARF.GuiMarker.prototype.__processCallbacks.call(this)};SKARF.SliderMarker=function(a){SKARF.GuiMarker.call(this,a);this.speed=a.params&&a.params.speed?a.params.speed:1;this.__callbackObjs.changed={name:this.__key+"_changed",fn:void 0}};
SKARF.SliderMarker.prototype=Object.create(SKARF.GuiMarker.prototype);SKARF.SliderMarker.prototype.constructor=SKARF.SliderMarker;SKARF.GuiMarkerFactory.register("slider",SKARF.SliderMarker);SKARF.SliderMarker.prototype.__processCallbacks=function(){var a=Math.abs(this.__dRotation);!isNaN(this.__dRotation)&&a>=this.__rotThresholdLow&&a<=this.__rotThresholdHigh&&this.__invokeCallback("changed",{guiMarker:this,delta:this.__dRotation*this.speed});SKARF.GuiMarker.prototype.__processCallbacks.call(this)};
SKARF.ComboBoxMarker=function(a){SKARF.GuiMarker.call(this,a);this.__callbackObjs.changed={name:this.__key+"_changed",fn:void 0};if(!a.params||!a.params.numChoices)throw Error("numChoices not specified as a parameter");this.numChoices=a.params.numChoices;this.currId=0};SKARF.ComboBoxMarker.prototype=Object.create(SKARF.GuiMarker.prototype);SKARF.ComboBoxMarker.prototype.constructor=SKARF.ComboBoxMarker;SKARF.GuiMarkerFactory.register("combobox",SKARF.ComboBoxMarker);
SKARF.ComboBoxMarker.prototype.__processCallbacks=function(){var a=Math.floor(this.__rotation/360*this.numChoices);a!==this.currId&&(this.__invokeCallback("changed",{guiMarker:this,selectedId:a,rotation:this.__rotation}),this.currId=a);SKARF.GuiMarker.prototype.__processCallbacks.call(this)};SKARF.TimerMarker=function(a){SKARF.GuiMarker.call(this,a);this.__callbackObjs.reached={name:this.__key+"_reached",fn:void 0};this.time=a.params&&a.params.time||2;this.currTime=0;this.reached=!1};
SKARF.TimerMarker.prototype=Object.create(SKARF.GuiMarker.prototype);SKARF.TimerMarker.prototype.constructor=SKARF.TimerMarker;SKARF.GuiMarkerFactory.register("timer",SKARF.TimerMarker);SKARF.TimerMarker.prototype.detected=function(a,b){SKARF.GuiMarker.prototype.detected.call(this,a,b);this.currTime+=a;!this.reached&&this.currTime>=this.time&&(this.reached=!0,this.__invokeCallback("reached",{guiMarker:this}))};SKARF.TimerMarker.prototype.hidden=function(){this.currTime=0;this.reached=!1;SKARF.GuiMarker.prototype.hidden.call(this)};
SKARF.TimerMarker.prototype.resetTimer=function(){this.currTime=0};SKARF.ModelLoaderFactory={mappings:{},create:function(a){if(!a)throw Error("Model type not specified");if(!this.mappings.hasOwnProperty(a))throw Error("SKARF.ModelLoader of this type has not been registered with SKARF.ModelLoaderFactory: "+a);return new this.mappings[a]},register:function(a,b){if(this.mappings.hasOwnProperty(a))throw Error("Mapping name already exists: "+a);this.mappings[a]=b}};
SKARF.ModelLoader=function(){this.loader=null};SKARF.ModelLoader.prototype.loadForMarker=function(a,b,c,d,f,e){throw Error("Abstract method not implemented");};
SKARF.ModelLoader.prototype.transformAndParent=function(a,b,c,d,f){b&&b.traverse(function(b){if(b instanceof THREE.Mesh){b.geometry.__jsonData=a;var g=new THREE.Matrix4;a.translate&&g.setPosition(new THREE.Vector3(a.translate[0],a.translate[1],a.translate[2]));if(a.rotate){var h=new THREE.Matrix4,k=new THREE.Vector3(THREE.Math.degToRad(a.rotate[0]),THREE.Math.degToRad(a.rotate[1]),THREE.Math.degToRad(a.rotate[2]));h.makeRotationFromEuler(k,a.rotationOrder);g.multiply(h)}a.scale&&g.scale(new THREE.Vector3(a.scale[0]*
d,a.scale[1]*d,a.scale[2]*d));b.geometry.applyMatrix(g);c.add(b);f.materials.push(b.material);b.geometry.computeBoundingBox();b.castShadow=!0;b.receiveShadow=!0}})};SKARF.EmptyModelLoader=function(){SKARF.ModelLoader.call(this);this.loader=new THREE.JSONLoader;console.log("Created a SKARF.EmptyModelLoader")};SKARF.EmptyModelLoader.prototype=Object.create(SKARF.ModelLoader.prototype);SKARF.EmptyModelLoader.prototype.constructor=SKARF.EmptyModelLoader;SKARF.ModelLoaderFactory.register("empty",SKARF.EmptyModelLoader);
SKARF.EmptyModelLoader.prototype.loadForMarker=function(a,b,c,d,f,e){this.transformAndParent(a,null,c,d,e);console.log("Loaded empty transform for marker id "+b)};SKARF.JsonModelLoader=function(){SKARF.ModelLoader.call(this);this.loader=new THREE.JSONLoader;console.log("Created a SKARF.JsonModelLoader")};SKARF.JsonModelLoader.prototype=Object.create(SKARF.ModelLoader.prototype);SKARF.JsonModelLoader.prototype.constructor=SKARF.JsonModelLoader;SKARF.ModelLoaderFactory.register("json",SKARF.JsonModelLoader);
SKARF.JsonModelLoader.prototype.loadForMarker=function(a,b,c,d,f,e){var g=this;this.loader.load(a.url,function(h,k){var l,m;l=0;for(m=k.length;l<m;l++)k[l].wireframe=f;l=new THREE.Mesh(h,new THREE.MeshFaceMaterial(k));g.transformAndParent(a,l,c,d,e);console.log("Loaded mesh "+a.url+" for marker id "+b)})};
SKARF.JsonBinaryModelLoader=function(){SKARF.ModelLoader.call(this);if("undefined"===typeof THREE.BinaryLoader)throw Error("THREE.BinaryLoader does not exist. Have you included BinaryLoader.js?");this.loader=new THREE.BinaryLoader;console.log("Created a SKARF.JsonBinaryModelLoader")};SKARF.JsonBinaryModelLoader.prototype=Object.create(SKARF.JsonModelLoader.prototype);SKARF.JsonBinaryModelLoader.prototype.constructor=SKARF.JsonBinaryModelLoader;SKARF.ModelLoaderFactory.register("json_bin",SKARF.JsonBinaryModelLoader);
SKARF.ObjModelLoader=function(){SKARF.ModelLoader.call(this);if("undefined"===typeof THREE.OBJMTLLoader)throw Error("THREE.OBJMTLLoader does not exist. Have you included OBJMTLLoader.js and MTLLoader.js?");this.loader=new THREE.OBJMTLLoader;console.log("Created a SKARF.ObjModelLoader");var a=this;this.loader.addEventListener("load",function(b){b=b.content;var c,d,f,e,g,h;f=0;for(g=b.children.length;f<g;f++)for(c=b.children[f],e=0,h=c.children.length;e<h;e++)d=c.children[e],d instanceof THREE.Mesh&&
(d.material.wireframe=a.isWireframeVisible);a.transformAndParent(a.model,b,a.markerTransform,a.overallScale,a.markerManager);console.log("Loaded mesh "+a.model.url+" for marker id "+a.markerId)})};SKARF.ObjModelLoader.prototype=Object.create(SKARF.ModelLoader.prototype);SKARF.ObjModelLoader.prototype.constructor=SKARF.ObjModelLoader;SKARF.ModelLoaderFactory.register("obj",SKARF.ObjModelLoader);
SKARF.ObjModelLoader.prototype.loadForMarker=function(a,b,c,d,f,e){this.model=a;this.markerId=b;this.markerTransform=c;this.overallScale=d;this.isWireframeVisible=f;this.markerManager=e;b=a.url.replace(/\.obj/g,".mtl");this.loader.load(a.url,b)};SKARF.MarkerManager=function(a){this.markersJsonFile=a;this.markerData=null;this.modelLoaders={};this.materials=[];this.__load()};
SKARF.MarkerManager.prototype.__load=function(){console.log("Loading markers json file: "+this.markersJsonFile);var a=this;$.ajax({url:this.markersJsonFile,async:!1}).done(function(b){a.markerData=b;console.log("Loaded "+a.markersJsonFile);console.log("Main marker id: "+a.markerData.mainMarkerId)}).error(function(a,c,d){throw Error("error loading "+this.markersJsonFile+": "+d);})};
SKARF.MarkerManager.prototype.loadForMarker=function(a,b,c,d){c=c||1;if(this.markerData.models&&this.markerData.models[a]){var f=this.markerData.models[a];if(f){var e=f.type;this.modelLoaders.hasOwnProperty(e)||(this.modelLoaders[e]=SKARF.ModelLoaderFactory.create(e));this.modelLoaders[e].loadForMarker(f,a,b,c,d,this)}}else if(this.markerData.guiMarkers&&this.markerData.guiMarkers[a]){if(d=this.markerData.guiMarkers[a])e=d.type,d=SKARF.GuiMarkerFactory.create(e,{name:d.name,key:d.key,markerId:a,markerTransform:b,
markerSize:c,params:d.params}),b.guiMarker=d}else console.warn("Unable to find data for marker id "+a)};THREE.Matrix4.prototype.setFromArray=function(a){return this.set(a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15])};function copyMarkerMatrix(a,b){b[0]=a.m00;b[1]=-a.m10;b[2]=a.m20;b[3]=0;b[4]=a.m01;b[5]=-a.m11;b[6]=a.m21;b[7]=0;b[8]=-a.m02;b[9]=a.m12;b[10]=-a.m22;b[11]=0;b[12]=a.m03;b[13]=-a.m13;b[14]=a.m23;b[15]=1}
SKARF.ArLibFactory={mappings:{},create:function(a,b){if(!a)throw Error("SKARF.ArLib type not specified");if(!this.mappings.hasOwnProperty(a))throw Error("SKARF.ArLib of this type has not been registered with SKARF.ArLibFactory: "+a);return new this.mappings[a](b)},register:function(a,b){if(this.mappings.hasOwnProperty(a))throw Error("Mapping name already exists: "+a);this.mappings[a]=b}};
SKARF.ArLib=function(a){if("undefined"===typeof a.trackingElem)throw Error("trackingElem not specified");this.trackingElem=a.trackingElem;if("undefined"===typeof a.markerSize)throw Error("markerSize not specified");this.markerSize=a.markerSize;this.verticalFov=a.verticalFov;if("undefined"===typeof a.mainMarkerId)throw Error("mainMarkerId not specified");this.mainMarkerId=a.mainMarkerId;this.debug="undefined"===typeof a.debug?!1:a.debug;this.compensationMatrix=new THREE.Matrix4;this.mainMarkerHasEverBeenDetected=
!1;this.tmpMat=new THREE.Matrix4;this.renderer=this.canvasElem=null;this.markers={}};SKARF.ArLib.prototype.init=function(){throw Error("Abstract method not implemented");};SKARF.ArLib.prototype.update=function(a){throw Error("Abstract method not implemented");};
SKARF.JsArToolKitArLib=function(a){SKARF.ArLib.call(this,a);this.threshold=a.threshold||128;this.compensationMatrix=(new THREE.Matrix4).makeScale(1,1,-1);this.compensationMatrix.multiply((new THREE.Matrix4).makeRotationX(THREE.Math.degToRad(90)));this.resultMat=new NyARTransMatResult;this.tmp={}};SKARF.JsArToolKitArLib.prototype=Object.create(SKARF.ArLib.prototype);SKARF.JsArToolKitArLib.prototype.constructor=SKARF.JsArToolKitArLib;SKARF.ArLibFactory.register("jsartoolkit",SKARF.JsArToolKitArLib);
SKARF.JsArToolKitArLib.prototype.init=function(){DEBUG=this.debug;this.raster=new NyARRgbRaster_Canvas2D(this.canvasElem);this.flarParam=new FLARParam(this.canvasElem.width,this.canvasElem.height,this.verticalFov);this.detector=new FLARMultiIdMarkerDetector(this.flarParam,this.markerSize);this.detector.setContinueMode(!0);this.initCameraProjMatrix()};SKARF.JsArToolKitArLib.prototype.initCameraProjMatrix=function(){var a=new Float32Array(16);this.flarParam.copyCameraMatrix(a,0.1,1E4);this.renderer.initCameraProjMatrix(a)};
SKARF.JsArToolKitArLib.prototype.update=function(a){DEBUG=this.debug;var b=Object.keys(this.markers),c,d;for(c=0;c<b.length;c++)this.renderer.__setMarkerDetected(b[c],!1);var b=this.detector.detectMarkerLite(this.raster,this.threshold),f,e;for(c=0;c<b;c++){f=this.detector.getIdMarkerData(c);e=-1;if(4>=f.packetLength)for(d=e=0;d<f.packetLength;d++)e=e<<8|f.getPacketData(d);"undefined"===typeof this.markers[e]&&(this.markers[e]={},d=this.renderer.__createTransformForMarker(e,this.markerSize),this.renderer.loadForMarker(e,
d,this.markerSize),e==this.mainMarkerId&&(this.mainMarkerHasEverBeenDetected=!0));try{this.detector.getTransformMatrix(c,this.resultMat),copyMarkerMatrix(this.resultMat,this.tmp),this.tmpMat.setFromArray(this.tmp),this.renderer.__setCurrSolvedMatrixValues(e,this.tmpMat),this.renderer.__setMarkerDetected(e,!0)}catch(g){console.log(g.message)}}this.renderer.__updateSolvedScene(a,this.mainMarkerId)};SKARF.JsArucoArLib=function(a){SKARF.ArLib.call(this,a)};SKARF.JsArucoArLib.prototype=Object.create(SKARF.ArLib.prototype);
SKARF.JsArucoArLib.prototype.constructor=SKARF.JsArucoArLib;SKARF.ArLibFactory.register("jsaruco",SKARF.JsArucoArLib);SKARF.JsArucoArLib.prototype.init=function(){this.detector=new AR.Detector;this.posit=new POS.Posit(this.markerSize,4*this.canvasElem.height/3);this.context=this.canvasElem.getContext("2d")};
SKARF.JsArucoArLib.prototype.update=function(a){var b=this.context.getImageData(0,0,this.canvasElem.width,this.canvasElem.height),b=this.detector.detect(b);this.debug&&(this.__drawCorners(b),this.__drawId(b));this.__updateScenes(a,b)};
SKARF.JsArucoArLib.prototype.__updateScenes=function(a,b){var c,d,f,e;c=Object.keys(this.markers);var g,h;for(g=0;g<c.length;g++)this.renderer.__setMarkerDetected(c[g],!1);for(g=0;g<b.length;g++){e=b[g].id;c=b[g].corners;"undefined"===typeof this.markers[e]&&(console.log("Creating new marker root for id "+e),this.markers[e]={},d=this.renderer.__createTransformForMarker(e,this.markerSize),this.renderer.loadForMarker(e,d,this.markerSize),e==this.mainMarkerId&&(this.mainMarkerHasEverBeenDetected=!0));
for(h=0;h<c.length;h++)d=c[h],d.x=0.97*(d.x-this.canvasElem.width/2),d.y=0.97*(this.canvasElem.height/2-d.y);try{f=this.posit.pose(c),this.__updateMatrix4FromRotAndTrans(f.bestRotation,f.bestTranslation),this.tmpMat.multiply((new THREE.Matrix4).makeRotationX(THREE.Math.degToRad(90))),this.renderer.__setCurrSolvedMatrixValues(e,this.tmpMat),this.renderer.__setMarkerDetected(e,!0)}catch(k){console.log(k.message)}}this.renderer.__updateSolvedScene(a,this.mainMarkerId)};
SKARF.JsArucoArLib.prototype.__updateMatrix4FromRotAndTrans=function(a,b){this.tmpMat.set(a[0][0],a[0][1],-a[0][2],b[0],a[1][0],a[1][1],-a[1][2],b[1],-a[2][0],-a[2][1],a[2][2],-b[2],0,0,0,1)};
SKARF.JsArucoArLib.prototype.__drawCorners=function(a){var b,c,d,f,e,g;d=0;for(e=a.length;d<e;d++){b=a[d].corners;this.context.lineWidth=2;this.context.strokeStyle="red";this.context.beginPath();f=0;for(g=b.length;f<g;f++)c=b[f],this.context.moveTo(c.x,c.y),c=b[(f+1)%b.length],this.context.lineTo(c.x,c.y);this.context.stroke();this.context.closePath();this.context.lineWidth=3;this.context.strokeStyle="green";this.context.strokeRect(b[0].x-2,b[0].y-2,4,4)}};
SKARF.JsArucoArLib.prototype.__drawId=function(a){var b,c,d,f;this.context.font="12pt Calibri";this.context.fillStyle="yellow";d=0;for(f=a.length;d<f;d++)b=a[d].corners,c=b[0].x,b=b[0].y,this.context.fillText(a[d].id,c,b)};
SKARF.RendererFactory={mappings:{},create:function(a,b){if(!a)throw Error("SKARF.Renderer type not specified");if(!this.mappings.hasOwnProperty(a))throw Error("SKARF.Renderer of this type has not been registered with SKARF.RendererFactory: "+a);return new this.mappings[a](b)},register:function(a,b){if(this.mappings.hasOwnProperty(a))throw Error("Mapping name already exists: "+a);this.mappings[a]=b}};
SKARF.Renderer=function(a){if("undefined"===typeof a.renderer)throw Error("renderer not specified");this.renderer=a.renderer;if("undefined"===typeof a.scene)throw Error("scene not specified");this.scene=a.scene;if("undefined"===typeof a.camera)throw Error("camera not specified");this.camera=a.camera;if("undefined"===typeof a.markersJsonFile)throw Error("markersJsonFile not specified");this.markersJsonFile=a.markersJsonFile;this.isWireframeVisible="undefined"===typeof a.displayWireframe?!1:a.displayWireframe;
this.isLocalAxisVisible="undefined"===typeof a.displayLocalAxis?!1:a.displayLocalAxis;this.markerManager=new SKARF.MarkerManager(this.markersJsonFile);this.localAxes=[];this.markerTransforms={};this.callbacks={};this.backgroundCanvasElem=this.arLib=null};SKARF.Renderer.prototype.init=function(){this.__setupBackgroundVideo()};
SKARF.Renderer.prototype.addCallback=function(a,b){this.callbacks.hasOwnProperty(a)||(this.callbacks[a]=[]);if(b)if("function"===typeof b)this.callbacks[a].push(b);else throw Error("Specified callbackFn is not a function");else throw Error("Callback function not defined");};SKARF.Renderer.prototype.getMainMarkerId=function(){return this.markerManager.markerData.mainMarkerId};SKARF.Renderer.prototype.update=function(a){throw Error("Abstract method not implemented");};
SKARF.Renderer.prototype.__setupBackgroundVideo=function(){throw Error("Abstract method not implemented");};SKARF.Renderer.prototype.__createTransformForMarker=function(a,b){throw Error("Abstract method not implemented");};SKARF.Renderer.prototype.showChildrenOfMarker=function(a,b){this.__showChildren(this.markerTransforms[a],b)};SKARF.Renderer.prototype.__showChildren=function(a,b){throw Error("Abstract method not implemented");};
SKARF.Renderer.prototype.loadForMarker=function(a,b,c){this.markerManager.loadForMarker(a,b,c,this.isWireframeVisible)};SKARF.Renderer.prototype.__setCurrSolvedMatrixValues=function(a,b){throw Error("Abstract method not implemented");};SKARF.Renderer.prototype.__setMarkerDetected=function(a,b){this.markerTransforms[a].detected=b};SKARF.Renderer.prototype.__updateSolvedScene=function(a,b){throw Error("Abstract method not implemented");};
SKARF.Renderer.prototype.setWireframeVisible=function(a){throw Error("Abstract method not implemented");};SKARF.Renderer.prototype.setLocalAxisVisible=function(a){throw Error("Abstract method not implemented");};SKARF.ThreeJsRenderer=function(a){SKARF.Renderer.call(this,a);this.mainMarkerRootSolvedMatrixInv=new THREE.Matrix4};SKARF.ThreeJsRenderer.prototype=Object.create(SKARF.Renderer.prototype);SKARF.ThreeJsRenderer.prototype.constructor=SKARF.ThreeJsRenderer;
SKARF.RendererFactory.register("threejs",SKARF.ThreeJsRenderer);SKARF.ThreeJsRenderer.prototype.update=function(a){this.videoTex.needsUpdate=!0;this.renderer.autoClear=!1;this.renderer.clear();if(this.callbacks.hasOwnProperty("render")){var b=this.callbacks.render,c,d;c=0;for(d=b.length;c<d;c++)b[c](a)}this.renderer.render(this.videoScene,this.videoCam);this.renderer.render(this.scene,this.camera)};
SKARF.ThreeJsRenderer.prototype.__showChildren=function(a,b){var c=a.children,d,f;d=0;for(f=c.length;d<f;d++)b?(c[d].visible=b,c[d]instanceof THREE.AxisHelper&&(c[d].visible=c[d].visible&&this.isLocalAxisVisible)):c[d].visible=b};
SKARF.ThreeJsRenderer.prototype.__setupBackgroundVideo=function(){this.videoTex=new THREE.Texture(this.backgroundCanvasElem);this.videoPlane=new THREE.PlaneGeometry(2,2);this.videoMaterial=new THREE.MeshBasicMaterial({map:this.videoTex,depthTest:!1,depthWrite:!1});var a=new THREE.Mesh(this.videoPlane,this.videoMaterial);this.videoScene=new THREE.Scene;this.videoCam=new THREE.Camera;this.videoScene.add(a);this.videoScene.add(this.videoCam)};
SKARF.ThreeJsRenderer.prototype.__createTransformForMarker=function(a,b){var c=new THREE.Object3D;c.matrixAutoUpdate=!1;c.currSolvedMatrix=new THREE.Matrix4;this.markerTransforms[a]=c;this.scene.add(c);var d=new THREE.AxisHelper(2*b);d.visible=this.isLocalAxisVisible;this.localAxes.push(d);c.add(d);return c};SKARF.ThreeJsRenderer.prototype.__setCurrSolvedMatrixValues=function(a,b){this.markerTransforms[a].currSolvedMatrix.copy(b)};
SKARF.ThreeJsRenderer.prototype.setWireframeVisible=function(a){this.isWireframeVisible=a;var b,c,d,f,e;b=0;for(d=this.markerManager.materials.length;b<d;b++)if(e=this.markerManager.materials[b],e instanceof THREE.MeshFaceMaterial)for(c=0,f=e.materials.length;c<f;c++)e.materials[c].wireframe=a;else e.wireframe=a};SKARF.ThreeJsRenderer.prototype.setLocalAxisVisible=function(a){this.isLocalAxisVisible=a;var b,c;b=0;for(c=this.localAxes.length;b<c;b++)this.localAxes[b].visible=a};
SKARF.ThreeJsRenderer.prototype.__updateSolvedScene=function(a,b){this.markerTransforms[b]&&this.markerTransforms[b].detected&&(this.camera.matrix.copy(this.arLib.compensationMatrix),this.camera.matrix.multiply(this.mainMarkerRootSolvedMatrixInv.getInverse(this.markerTransforms[b].currSolvedMatrix)),this.camera.matrixWorldNeedsUpdate=!0);var c=this;Object.keys(this.markerTransforms).forEach(function(b){c.markerTransforms[b].detected?(c.markerTransforms[b].matrix.copy(c.camera.matrix),c.markerTransforms[b].matrix.multiply(c.markerTransforms[b].currSolvedMatrix),
c.markerTransforms[b].matrix.multiply(c.arLib.compensationMatrix),c.markerTransforms[b].matrixWorldNeedsUpdate=!0,c.__showChildren(c.markerTransforms[b],!0),c.markerTransforms[b].guiMarker&&c.markerTransforms[b].guiMarker.detected(a,c.markerTransforms[b].matrix)):(c.__showChildren(c.markerTransforms[b],!1),c.markerTransforms[b].guiMarker&&c.markerTransforms[b].guiMarker.hidden())})};SKARF.ThreeJsRenderer.prototype.initCameraProjMatrix=function(a){this.camera.projectionMatrix.setFromArray(a)};
SKARF.Skarf=function(a){if("undefined"===typeof a.arLibType)throw Error("arLibType not specified");this.arLibType=a.arLibType;if("undefined"===typeof a.trackingElem)throw Error("trackingElem not specified");this.trackingElem=a.trackingElem;if("undefined"===typeof a.markerSize)throw Error("markerSize not specified");this.markerSize=a.markerSize;this.verticalFov=a.verticalFov;this.threshold=a.threshold||128;this.debug="undefined"===typeof a.debug?!1:a.debug;this.canvasContainerElem=a.canvasContainerElem;
this.rendererType="threejs";if("undefined"===typeof a.renderer)throw Error("renderer not specified");this.renderer=a.renderer;if("undefined"===typeof a.scene)throw Error("scene not specified");this.scene=a.scene;if("undefined"===typeof a.camera)throw Error("camera not specified");this.camera=a.camera;if("undefined"===typeof a.markersJsonFile)throw Error("markersJsonFile not specified");this.markersJsonFile=a.markersJsonFile;this.__init()};
SKARF.Skarf.prototype.__create2dCanvas=function(){this.canvasElem=document.createElement("canvas");this.canvasElem.width=this.trackingElem.width;this.canvasElem.height=this.trackingElem.height;this.canvasContainerElem?this.canvasContainerElem.append(this.canvasElem):$("body").append(this.canvasElem);this.context=this.canvasElem.getContext("2d")};
SKARF.Skarf.prototype.__init=function(){this.__create2dCanvas();this.renderer=SKARF.RendererFactory.create(this.rendererType,{renderer:this.renderer,scene:this.scene,camera:this.camera,markersJsonFile:this.markersJsonFile});this.arLib=SKARF.ArLibFactory.create(this.arLibType,{trackingElem:this.trackingElem,markerSize:this.markerSize,verticalFov:this.verticalFov,mainMarkerId:this.renderer.getMainMarkerId(),threshold:this.threshold,debug:this.debug});this.arLib.renderer=this.renderer;this.renderer.arLib=
this.arLib;this.arLib.canvasElem=this.canvasElem;this.renderer.backgroundCanvasElem=this.canvasElem;this.renderer.init();this.arLib.init()};SKARF.Skarf.prototype.update=function(a){this.context.drawImage(this.trackingElem,0,0,this.canvasElem.width,this.canvasElem.height);this.canvasElem.changed=!0;this.arLib.update(a);this.renderer.update(a)};SKARF.Skarf.prototype.addCallback=function(a,b){this.renderer.addCallback(a,b)};SKARF.Skarf.prototype.mainMarkerDetected=function(){return this.arLib.mainMarkerHasEverBeenDetected};
SKARF.Skarf.prototype.initCameraProjMatrix=function(){this.arLib instanceof SKARF.JsArToolKitArLib&&this.arLib.initCameraProjMatrix()};
